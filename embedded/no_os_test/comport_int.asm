;PRELIMINARY SETUP
[BITS 16]
[ORG 0X7C00]

;BOOTLOADER CODE
	JMP START

SCREENPOS:
	DW 0

CLRSCR:
	PUSH ES
	PUSH AX
	PUSH CX
	PUSH DI

	MOV AX, 0XB800
	MOV ES, AX
	XOR DI, DI
	MOV AX, 0X0720
	MOV CX, 2000

	CLD
	REP STOSW

	POP DI
	POP CX
	POP AX
	POP ES

	RET

SERIAL:
	PUSH AX
	PUSH BX
	PUSH DX
	PUSH ES

	MOV DX, 0X3FA
	IN AL, DX
	AND AL, 0X0F
	CMP AL, 4
	JNE SKIPALL
	
	MOV DX, 0X3F8
	IN AL, DX

	MOV DX, 0XB800
	MOV ES, DX
	MOV BX, [CS:SCREENPOS]
	MOV [ES:BX], AL
	ADD WORD [CS:SCREENPOS], 2
	CMP WORD [CS:SCREENPOS], 4000
	JNE SKIPALL

	CALL CLRSCR
	MOV WORD [CS:SCREENPOS], 0

SKIPALL:
	MOV AL, 0X20
	OUT 0X20, AL

	POP ES
	POP DX
	POP BX
	POP AX
	IRET


START:
	CALL CLRSCR
	MOV AH, 0
	MOV AL, 0XE3
	XOR DX, DX
	INT 0X14

	XOR AX, AX
	MOV ES, AX
	MOV WORD [ES:0X0C*4], SERIAL
	MOV [ES:0X0C*4+2], CS

	MOV DX, 0X3FC
	IN AL, DX
	OR AL, 8
	OUT DX, AL

	MOV DX, 0X3F9
	IN AL, DX
	OR AL, 1
	OUT DX, AL

	IN AL, 0X21
	AND AL, 0XEF
	OUT 0X21, AL

MAIN:
	MOV AH, 0
	INT 0X16
	PUSH AX

RETEST:
	MOV AH, 3
	XOR DX, DX
	INT 0X14
	AND AH, 32
	JZ RETEST

	POP AX
	MOV DX, 0X3F8
	OUT DX, AL
	JMP MAIN
